<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Argus Dashboard - Realtime</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    /* ======= NEON PURPLE THEME ======= */
    :root {
      --bg-deep: #0a0a0c;
      --card-bg: rgba(30, 30, 35, 0.7);
      --neon-purple: #bc13fe;
      --neon-blue: #00d2ff;
      --color-green: #39ff14; /* Neon Green */
      --color-yellow: #f0f000;
      --color-red: #ff3131;
      --text-main: #e0e0e0;
      --text-dim: #a0a0a0;
      --border-color: rgba(188, 19, 254, 0.2);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-deep);
      background-image: radial-gradient(circle at 50% -20%, #25103f 0%, #0a0a0c 80%);
      color: var(--text-main);
      padding: 30px;
      min-height: 100vh;
    }

    h2 {
      font-weight: 300;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--neon-purple);
      text-shadow: 0 0 10px rgba(188, 19, 254, 0.5);
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* ======= GRID ======= */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
    }

    /* ======= NEON CARDS ======= */
    .user-card {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .user-card::before {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 4px;
        background: var(--neon-purple);
        opacity: 0.5;
    }

    .user-card:hover {
      transform: translateY(-5px);
      border-color: var(--neon-purple);
      box-shadow: 0 10px 30px rgba(188, 19, 254, 0.15);
    }

    .header-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .user-name a {
      font-size: 1.25rem;
      font-weight: 700;
      color: #fff;
      text-decoration: none;
      transition: 0.2s;
    }
    .user-name a:hover { color: var(--neon-purple); }

    .exam-name {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 15px;
      font-style: italic;
    }

    .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 8px currentColor;
    }

    .active .indicator { color: var(--color-green); background-color: var(--color-green); }
    .inactive .indicator { color: var(--color-red); background-color: var(--color-red); opacity: 0.5; }

	.online {
	  color: var(--color-green);
	  font-weight: bold;
	}

	.offline {
	  color: var(--color-red);
	  font-weight: bold;
	}

    /* ======= LOG AREA ======= */
    .event-log {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      padding: 10px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.75rem;
      height: 120px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .log-message {
      display: block;
      padding: 2px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    }
    .log-vision { color: var(--neon-purple); text-shadow: 0 0 5px rgba(188, 19, 254, 0.3); }
	
	.log-keyboard {
		color: var(--neon-blue); 
	}
	
/* 	.log-keyboard {
	  color: #0a7c86;} */ /* azul petr√≥leo */
	
    .log-focus {
	  color: #ff9f1c; /* laranja */
	  text-shadow: 0 0 4px rgba(255, 159, 28, 0.4);
	}
    /* .log-plugin { color: var(--neon-blue); } */
    .log-default { color: var(--text-dim); }

    .status-type {
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: 1px;
      margin-bottom: 8px;
      display: block;
    }

	.vision-frame {
      width: 100%;
      margin-top: 10px;
      border-radius: 10px;
      display: none;
    }

	.log-vision-frame {
	  color: #00ff9c;
	  text-shadow: 0 0 5px rgba(0, 255, 156, 0.4);
	}

    /* Scrollbar minimalista */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--neon-purple); border-radius: 10px; }
  </style>
  <link rel="icon" type="image/png" href="icons/Argus_Mascote_20250825_2025_16x24.png">
</head>
<body>

  <h2><span style="color:var(--neon-purple)">‚óè</span> Argus Vision Realtime</h2>
  
  <div id="dashboard" class="dashboard"></div>

  <script>
	const EVENTOS_PT = {
	        "NO_FACE": "SEM ROSTO",
	        "FACE_CENTER": "ROSTO_CENTRO",
	        "FACE_LEFT": "ROSTO_ESQUERDA",
	        "FACE_RIGHT": "ROSTO_DIREITA",
	        "FACE_UP": "ROSTO_CIMA",
	        "FACE_DOWN": "ROSTO_BAIXO",
	        "ROSTO_CENTRO": "ROSTO_CENTRO",
	        "ROSTO_ESQUERDA": "ROSTO_ESQUERDA",
	        "ROSTO_DIREITA": "ROSTO_DIREITA",
	        "ROSTO_CIMA": "ROSTO_CIMA",
	        "ROSTO_BAIXO": "ROSTO_BAIXO"
	    };

    const socket = new SockJS('/ws');
    const client = Stomp.over(socket);
    client.debug = null;

    const dashboard = document.getElementById('dashboard');
    const users = {};

    const PLUGIN_TIMEOUT = 20000;
    const VISION_TIMEOUT = 20000;

    client.connect({}, function () {
      client.subscribe('/topic/events', function (message) {
        let event;
        try {
          event = JSON.parse(message.body);
        } catch {
          return;
        }
		
		// üîπ Ignora eventos de movimento
		  if (event.action && event.action.startsWith('MOTION')) {
		    return;
		  }

        const key = `${event.exam}_${event.student}`;
        let card = users[key];

        if (!card) {
          card = createUserCard(event);
          users[key] = card;
          dashboard.appendChild(card.element);
        }

        const now = Date.now();

        // üîπ Atualiza timestamps por tipo
		if (event.type === 'vision' || event.type === 'vision_frame') card.lastVision = now;
		if (event.type === 'keyboard' || event.type === 'shortcut' || event.type === 'focus') card.lastPlugin = now;
		if (event.type === 'heartbeat') return;
        // üîπ Frame Base64
        if (event.type === 'vision_frame') {
          const img = card.element.querySelector('.vision-frame');
          if (img) {
            img.src = `data:image/jpeg;base64,${event.image}`;
            img.style.display = 'block';
          }
          //return;
		  updateUserCard(card, event);
		  return;
        }

        // üîπ Log normal
        updateUserCard(card, event);
      });
    });

    function createUserCard(event) {
      const element = document.createElement('div');
      element.className = 'user-card active';

      element.innerHTML = `
        <div class="header-info">
          <div class="user-name">
            <a href="/student.html?exam=${encodeURIComponent(event.exam)}&student=${encodeURIComponent(event.student)}" target="_blank">
              ${event.student || 'An√¥nimo'}
            </a>
          </div>
          <div class="indicator"></div>
		  <div style="display:flex; gap:12px; margin-top:10px;">
			<span class="plugin-status offline">PLUGIN</span>
			<span class="vision-status offline">VISION</span>
		  </div>
        </div>
        <div class="exam-name">ID: ${event.exam || 'Desconhecido'}</div>
        <span class="status-type">ONLINE</span>
        <div class="event-log"></div>
		
		<img class="vision-frame" style="display:none;" />
      `;

	  // üî¥ BOT√ÉO ENCERRAR PROVA
	  const shutdownBtn = document.createElement('button');
	  	  shutdownBtn.textContent = 'Encerrar Prova';
	  	  shutdownBtn.style.marginTop = '10px';
	  	  shutdownBtn.style.background = 'var(--color-red)';
	  	  shutdownBtn.style.color = '#fff';
	  	  shutdownBtn.style.border = 'none';
	  	  shutdownBtn.style.padding = '8px';
	  	  shutdownBtn.style.borderRadius = '6px';
	  	  shutdownBtn.style.cursor = 'pointer';

	  	  shutdownBtn.onclick = () => {
	  	    if (confirm(`Encerrar a prova de ${event.student}?`)) {
	  	      shutdownStudent(event.student);
	  	    }
	  	  };

	  	  element.appendChild(shutdownBtn);

      const now = Date.now();
      return {
        element,
        lastPlugin: now,
        lastVision: now,
        lastFrame: null
      };
}

	function shutdownStudent(student) {
	  fetch(`/api/command/shutdown/${encodeURIComponent(student)}`, {
	    method: 'POST'
	  })
	  .then(() => {
	    alert(`Comando de shutdown enviado para ${student}`);
	  })
	  .catch(err => {
	    alert('Erro ao enviar comando');
	    console.error(err);
	  });
	}

    function updateUserCard(card, event) {
      const log = card.element.querySelector('.event-log');
      const time = new Date(event.timestamp).toLocaleTimeString();
      const action = event.action || event.type || 'UNKNOWN';

      const msg = `[${time}] ${action}`;
      const span = document.createElement('span');
      span.className = `log-message ${getMessageClass(event)}`;
      span.textContent = msg;

      log.prepend(span);
      if (log.children.length > 20) log.removeChild(log.lastChild);
    }

    function getMessageClass(event) {
      switch (event.type) {
		case 'vision_frame': return 'log-vision-frame';
        case 'vision': return 'log-vision';
        case 'keyboard':
        case 'shortcut': return 'log-keyboard';
        case 'focus': return 'log-focus';
        default: return 'log-default';
      }
    }

    // üîπ CONTROLE DE ONLINE / OFFLINE
    setInterval(() => {
      const now = Date.now();

      Object.values(users).forEach(card => {
        const pluginOnline = now - card.lastPlugin < PLUGIN_TIMEOUT;
        const visionOnline = now - card.lastVision < VISION_TIMEOUT;

        const el = card.element;
        const status = el.querySelector('.status-type');

		const pluginEl = el.querySelector('.plugin-status');
		const visionEl = el.querySelector('.vision-status');

		pluginEl.className = `plugin-status ${pluginOnline ? 'online' : 'offline'}`;
		visionEl.className = `vision-status ${visionOnline ? 'online' : 'offline'}`;

        if (!pluginOnline && !visionOnline) {
          el.classList.add('inactive');
          el.classList.remove('active');
          status.textContent = 'OFFLINE';
          status.style.color = 'var(--color-red)';
        } else {
          el.classList.add('active');
          el.classList.remove('inactive');

          if (!visionOnline) {
            status.textContent = 'VISION OFFLINE';
            status.style.color = 'var(--color-yellow)';
          } else if (!pluginOnline) {
            status.textContent = 'PLUGIN OFFLINE';
            status.style.color = 'var(--color-yellow)';
          } else {
            status.textContent = 'ONLINE';
            status.style.color = 'var(--color-green)';
          }
        }
      });
    }, 1000);
  </script>
</body>
</html>