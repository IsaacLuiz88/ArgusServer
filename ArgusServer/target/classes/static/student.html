<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Argus - Detalhes do Aluno</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    /* ======= CORE STYLES ======= */
    :root {
      --color-primary: #00bcd4;
      --color-green: #28a745;
      --color-yellow: #ffc107;
      --color-red: #dc3545;
      --color-purple: #9c27b0; /* ArgusVision */
      --color-bg-dark: #111;
      --color-card-bg: #1e1e1e;
      --color-border: #333;
      --color-text-light: #eee;
    }

    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        padding: 20px; 
        background: var(--color-bg-dark); 
        color: var(--color-text-light); 
    }
    
    h2 { 
        color: var(--color-primary); 
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 5px;
        margin-bottom: 10px;
    }

    #header-info {
        margin-bottom: 20px;
        font-size: 1.1em;
    }

    /* ======= EVENT LOG AREA ======= */
    #events { 
        max-height: 75vh; 
        overflow-y:auto; 
        border: 1px solid var(--color-border); 
        border-radius: 8px;
        padding: 10px; 
        background: var(--color-card-bg); 
    }
    
    .evt { 
        padding: 8px; 
        margin-bottom: 5px;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .evt:hover { background: #222; }

    /* Estilos de n√≠vel de alerta */
    .level-green { color: var(--color-green); }
    .level-yellow { color: var(--color-yellow); }
    .level-red { color: var(--color-red); }

    .evt-time { font-weight: bold; margin-right: 10px; }

    /* Imagem (apenas para eventos de vis√£o) */
    .evt-image {
        max-width: 100%;
        max-height: 200px;
        margin-top: 10px;
        border: 2px solid var(--color-border);
        border-radius: 4px;
        display: block;
    }

    /* Estilos para o corpo da mensagem (cores do seu request) */
    .evt-message { font-family: 'Consolas', monospace; }
    
    /* 1. ArgusVision (Vis√£o) */
    .evt-vision .evt-message { color: var(--color-purple); } 
    
    /* 2. Plugin/Outros (Teclado/Mouse/Foco) */
    .evt-plugin .evt-message { color: var(--color-yellow); }
    
    /* 3. Padr√£o (Fallback) */
    .evt-default .evt-message { color: var(--color-text-light); }

  </style>
</head>
<body>
  <h2>üë§ Detalhes do Aluno</h2>
  <div id="header-info">
      <strong>Aluno:</strong> <span id="studentName"></span> | 
      <strong>Prova:</strong> <span id="examName"></span>
  </div>
  
  <h3>Logs de Eventos</h3>
  <div id="events"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const student = urlParams.get('student');
    const exam = urlParams.get('exam');

    document.getElementById('studentName').textContent = student;
    document.getElementById('examName').textContent = exam;

    const socket = new SockJS('/ws');
    const client = Stomp.over(socket);
    
    // Fun√ß√£o auxiliar para determinar a classe de estilo da mensagem
    function getEventClass(eventType) {
        if (eventType.toLowerCase() === 'vision') return 'evt-vision';
        if (['keyboard', 'mouse', 'focus', 'pause'].includes(eventType.toLowerCase())) return 'evt-plugin';
        return 'evt-default';
    }
	
	// Fun√ß√£o auxiliar para determinar a classe de estilo da mensagem
	   function getEventClass(eventType) {
	        // 1. ROXO para eventos de Vis√£o (ArgusVision)
	        if (eventType.toLowerCase() === 'vision') return 'evt-vision';
	        // 2. AMARELO para eventos do Plugin (Teclado, Mouse, Foco, Pausa)
	        if (['keyboard', 'mouse', 'focus', 'pause'].includes(eventType.toLowerCase())) return 'evt-plugin';
	        // 3. Padr√£o (Neutro)
	        return 'evt-default';
	   }

    client.connect({}, function(frame) {
      console.log('Connected: ' + frame);
      client.subscribe('/topic/events', function(message) {
        let event;
        try { event = JSON.parse(message.body); } catch(e) { return; }

        if (event.student === student && event.exam === exam) {
          const el = document.createElement('div');
		  // Aplica a classe baseada no tipo de evento
          const eventClass = getEventClass(event.type);
          el.className = `evt ${eventClass}`;
		  
          const clientTime = new Date(event.time).toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
          });
	  
          let actionDetail = event.action || (event.x && event.y ? `(${event.x}, ${event.y})` : 'N/A');
          
          // Mensagem formatada
          const messageHtml = `
            <span class="evt-time">[${clientTime}]</span>
            <span class="evt-message">${event.type.toUpperCase()} (${actionDetail})</span>
            | N√≠vel: <strong class="level-${event.level}">${event.level.toUpperCase()}</strong>
          `;
          
          el.innerHTML = messageHtml;

		  document.getElementById('events').prepend(el);
        }
      });
    }, function(err){ console.error('STOMP error', err);});
  </script>
</body>
</html>